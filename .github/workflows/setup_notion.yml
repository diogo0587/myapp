name: Setup Notion Database (One-Time)

on:
  workflow_dispatch:
    inputs:
      parent_page_id:
        description: "ID da página do Notion onde a database será criada (page_id)"
        required: true
        type: string

jobs:
  setup-notion-db:
    runs-on: ubuntu-latest

    steps:
      - name: Criar database no Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          PARENT_PAGE_ID: ${{ github.event.inputs.parent_page_id }}
        run: |
          if [ -z "$NOTION_TOKEN" ]; then
            echo "ERROR: Secret NOTION_TOKEN não está configurado."
            exit 1
          fi

          if [ -z "$PARENT_PAGE_ID" ]; then
            echo "ERROR: parent_page_id não foi informado."
            exit 1
          fi

          echo "Criando database de notificações no Notion..."

          RESPONSE=$(curl -sS -X POST https://api.notion.com/v1/databases \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            --data @- <<EOF
          {
            "parent": { "page_id": "$PARENT_PAGE_ID" },
            "title": [
              {
                "type": "text",
                "text": { "content": "Notificações do App" }
              }
            ],
            "properties": {
              "Name": {
                "title": {}
              },
              "App": {
                "rich_text": {}
              },
              "Body": {
                "rich_text": {}
              },
              "Timestamp": {
                "date": {}
              }
            }
          }
EOF
          )

          echo "Resposta do Notion:"
          echo "$RESPONSE"

          DB_ID=$(echo "$RESPONSE" | python -c "import sys, json; print(json.load(sys.stdin).get('id', ''))")
          if [ -z "$DB_ID" ]; then
            echo "ERROR: Não foi possível obter o database_id da resposta."
            exit 1
          fi

          echo ""
          echo "Database criada com sucesso!"
          echo "NOTION_DATABASE_ID (para usar no app):"
          echo "$DB_ID"